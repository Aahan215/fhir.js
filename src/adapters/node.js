// Generated by CoffeeScript 1.9.3
(function() {
    var request = require('request');
    var mkFhir = require('../fhir');

    var adapter = {
        http: function(args) {
            args.headers = args.headers || {};
            args.headers["Accept"] = "application/json";
            args.headers["Content-Type"] = "application/json";
            args.body = args.data;
            args.json = true;
            return request( args, function(err, response, body) {
                var headers = function(x) {
                    return response.headers[x.toLowerCase()];
                };
                if (err) {
                    return args.error(err, response.statusCode, headers,args);
                } else if (response.statusCode > 399) {
                    return args.error(body, response.statusCode, headers,args);
                } else {
                    return args.success(body, response.statusCode, headers,args);
                }
            });
        }
    };

    var wrappToErrbackForm = function(fn) {
        return function(args, cb) {
            if(cb){
                args.callback = cb;
                args.success = function(res, status, headersFn, query) {
                    return cb(null, res, status, headersFn, query);
                };
                args.error = function(err, status, headersFn, query) {
                    return cb(err, null, status, headersFn, query);
                };
            }
            return fn(args);
        };
    };

    module.exports = function(config) {
        var fhir = mkFhir(config, adapter);
        var wrp = {};
        for(var k in fhir){wrp[k] = wrappToErrbackForm(fhir[k]); }
        return wrp;
    };

}).call(this);
